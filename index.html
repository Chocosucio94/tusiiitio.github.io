import { Button } from "../components/ui/button";
import { motion } from "framer-motion";
import { LockIcon, SparklesIcon } from "lucide-react";
import { useState, useEffect } from "react";

const services = [
  { name: "Corte de pelo", price: 12, duration: 30 },
  { name: "Corte + Barba", price: 16, duration: 40 },
  { name: "Corte + Cejas", price: 15, duration: 40 },
  { name: "Corte + Barba + Cejas", price: 16, duration: 45 },
  { name: "Rapado", price: 6, duration: 20 },
  { name: "Rapado + Barba", price: 11, duration: 30 },
  { name: "Rapado + Cejas", price: 9, duration: 30 },
  { name: "Rapado + Barba + Cejas", price: 13, duration: 35 },
  { name: "Arreglo de Barba", price: 7, duration: 20 },
  { name: "Perfilado Barba", price: 3, duration: 15 },
  { name: "Cejas", price: 3, duration: 10 }
];

const hours = [
  "10:00", "10:30", "11:00", "11:30", "12:00", "12:30", "13:00", "13:30",
  "16:00", "16:30", "17:00", "17:30", "18:00", "18:30", "19:00", "19:30"
];

function addMinutesToTime(time, minutesToAdd) {
  const [hoursPart, minutesPart] = time.split(":").map(Number);
  const date = new Date();
  date.setHours(hoursPart);
  date.setMinutes(minutesPart + minutesToAdd);
  return date.toTimeString().slice(0, 5);
}

function getServiceAvailability(service, bookedSlots) {
  const available = [];
  for (let i = 0; i < hours.length; i++) {
    const startTime = hours[i];
    const endTime = addMinutesToTime(startTime, service.duration);
    const endIndex = hours.indexOf(endTime);
    if (endIndex === -1) continue;
    const timeRange = hours.slice(i, endIndex);
    const isAvailable = timeRange.every(h => !bookedSlots.includes(h));
    if (isAvailable) available.push(startTime);
  }
  return available;
}

export default function TheBarberyHuelva() {
  const [bookedSlots, setBookedSlots] = useState([]);
  const [selectedSlot, setSelectedSlot] = useState(null);
  const [isBooking, setIsBooking] = useState(false);
  const [clientName, setClientName] = useState("");
  const [selectedService, setSelectedService] = useState(services[0]);
  const [confirmedName, setConfirmedName] = useState("");

  const handleBooking = async (hour) => {
    if (!clientName.trim()) {
      alert("Por favor, introduce tu nombre antes de reservar.");
      return;
    }

    const startIndex = hours.indexOf(hour);
    const endTime = addMinutesToTime(hour, selectedService.duration);
    const endIndex = hours.indexOf(endTime);

    const conflict = hours.slice(startIndex, endIndex).some(h => bookedSlots.includes(h));
    if (conflict) {
      alert("Este horario entra en conflicto con una cita ya reservada.");
      return;
    }

    setIsBooking(true);
    await new Promise(resolve => setTimeout(resolve, 800));

    const newReservation = { name: clientName, hour, service: selectedService.name };
    console.log("Reserva guardada en base de datos:", newReservation);

    const newBookedSlots = [...bookedSlots];
    for (let i = startIndex; i < endIndex; i++) {
      if (hours[i]) newBookedSlots.push(hours[i]);
    }

    setBookedSlots(newBookedSlots);
    setSelectedSlot(hour);
    setConfirmedName(clientName);
    setIsBooking(false);
    setClientName("");
  };

  useEffect(() => {
    document.title = "The Barbery Huelva ✂️";
  }, []);

  const availableSlots = getServiceAvailability(selectedService, bookedSlots);

  return (
    <main className="min-h-screen bg-gradient-to-br from-black via-zinc-900 to-zinc-800 text-white px-4 md:px-12 py-8 font-sans relative overflow-x-hidden">
      <motion.div
        className="absolute top-0 left-0 w-full h-full pointer-events-none bg-[radial-gradient(ellipse_at_top_left,_var(--tw-gradient-stops))] from-rose-500/10 via-transparent to-transparent"
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ duration: 2 }}
      />

      <section className="text-center py-16">
        <motion.h1
          className="text-6xl font-extrabold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-rose-400 to-pink-600 drop-shadow-xl"
          initial={{ opacity: 0, y: -60 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 1 }}
        >
          The Barbery Huelva
        </motion.h1>
        <motion.p
          className="text-xl text-zinc-300 mt-4"
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.5, duration: 1 }}
        >
          Donde el estilo urbano se encuentra con la elegancia.<br /> By Cristian Fernández.
        </motion.p>
      </section>

      <section className="text-center py-16">
        <motion.h2
          className="text-4xl font-bold mb-6 flex justify-center items-center gap-3 text-pink-500"
          initial={{ opacity: 0 }}
          whileInView={{ opacity: 1 }}
          transition={{ duration: 1 }}
        >
          <SparklesIcon /> Reserva tu cita
        </motion.h2>

        <input
          type="text"
          placeholder="Tu nombre..."
          value={clientName}
          onChange={(e) => setClientName(e.target.value)}
          className="mb-4 px-4 py-3 rounded-xl bg-zinc-900 border border-zinc-600 text-white placeholder-zinc-500 w-full max-w-xs mx-auto block"
        />

        <select
          value={selectedService.name}
          onChange={(e) => setSelectedService(services.find(s => s.name === e.target.value))}
          className="mb-6 px-4 py-3 rounded-xl bg-zinc-900 border border-zinc-600 text-white w-full max-w-xs mx-auto block"
        >
          {services.map(service => (
            <option key={service.name} value={service.name}>
              {service.name} - {service.price}€ ({service.duration} min)
            </option>
          ))}
        </select>

        <p className="text-lg text-zinc-300 mb-4">
          <strong>Resumen:</strong> {selectedService.name} | {selectedService.duration} min | {selectedService.price}€
        </p>

        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-5xl mx-auto">
          {hours.map((hour) => (
            <motion.div
              key={hour}
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.95 }}
              className="transition-all"
            >
              <Button
                onClick={() => handleBooking(hour)}
                disabled={!availableSlots.includes(hour) || isBooking}
                className={`rounded-xl px-6 py-4 w-full text-lg font-semibold shadow-lg transition duration-300 ease-in-out ${
                  !availableSlots.includes(hour)
                    ? "bg-gray-700 text-zinc-400 cursor-not-allowed border border-zinc-600"
                    : "bg-gradient-to-r from-rose-500 to-pink-500 hover:from-rose-600 hover:to-pink-600"
                }`}
              >
                {!availableSlots.includes(hour) ? `${hour} Ocupado` : hour}
              </Button>
            </motion.div>
          ))}
        </div>

        {selectedSlot && (
          <motion.p
            className="text-green-400 mt-8 text-2xl font-semibold"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ duration: 0.6 }}
          >
            ¡Cita reservada a las {selectedSlot} para {confirmedName}!
          </motion.p>
        )}
      </section>

      <section className="text-center py-16">
        <motion.h2
          className="text-3xl font-bold mb-4 flex justify-center items-center gap-2 text-rose-300"
          initial={{ opacity: 0 }}
          whileInView={{ opacity: 1 }}
          transition={{ duration: 1 }}
        >
          <LockIcon className="text-rose-400" /> Política de Privacidad
        </motion.h2>
        <p className="text-zinc-400 max-w-3xl mx-auto text-lg">
          En The Barbery Huelva, tu privacidad es sagrada. Tus datos se utilizan exclusivamente para agendar tu cita y mejorar tu experiencia. Nunca serán compartidos con terceros. Estás en buenas manos.
        </p>
      </section>
    </main>
  );
}
